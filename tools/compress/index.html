<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Compress Image Online - Free Image Compression Tool</title>
    <meta name="description" content="Free online image compression tool. Reduce image file size while maintaining quality. Batch processing supported.">
    <meta name="keywords" content="compress image, image compression, reduce file size, optimize image, photo compressor">
    <meta name="author" content="Free Image Tools Online">
    <link rel="canonical" href="https://freeimagetools.online/tools/compress/">
    
    <!-- Open Graph -->
    <meta property="og:title" content="Compress Image Online - Free Image Compression Tool">
    <meta property="og:description" content="Free online image compression tool. Reduce image file size while maintaining quality.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://freeimagetools.online/tools/compress/">
    <meta property="og:image" content="https://freeimagetools.online/assets/og-compress.png">
    
    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Compress Image Online - Free Image Compression Tool">
    <meta name="twitter:description" content="Free online image compression tool. Reduce image file size while maintaining quality.">
    <meta name="twitter:image" content="https://freeimagetools.online/assets/og-compress.png">
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="/assets/favicon.svg">
    <link rel="apple-touch-icon" href="/assets/apple-touch-icon.png">
    
    <!-- CSS -->
    <link rel="stylesheet" href="/styles/base.css">
    <link rel="stylesheet" href="/styles/theme.css">
    <link rel="stylesheet" href="/styles/header.css">
    <link rel="stylesheet" href="/styles/footer.css">
    <link rel="stylesheet" href="/styles/components.css">
    <link rel="stylesheet" href="/styles/tools.css">
    
    <!-- JSON-LD Structured Data -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "SoftwareApplication",
        "name": "Image Compression Tool",
        "description": "Free online image compression tool with quality control",
        "url": "https://freeimagetools.online/tools/compress/",
        "applicationCategory": "ImageEditorApplication",
        "operatingSystem": "Web Browser",
        "author": {
            "@type": "Organization",
            "name": "Free Image Tools Online"
        },
        "offers": {
            "@type": "Offer",
            "price": "0",
            "priceCurrency": "USD"
        }
    }
    </script>
</head>
<body>
    <!-- Skip to content -->
    <a href="#main-content" class="skip-to-content">Skip to content</a>
    
    <!-- Header -->
    <div id="header-container"></div>
    
    <!-- Main Content -->
    <main id="main-content">
        <div class="tool-container">
            <div class="tool-header">
                <h1 class="tool-title">Compress Image</h1>
                <p class="tool-description">Reduce image file size while maintaining quality</p>
            </div>
            
            <div class="tool-layout">
                <!-- Controls Panel -->
                <div class="tool-panel">
                    <h2 class="tool-panel-title">Compression Settings</h2>
                    
                    <!-- File Upload -->
                    <div class="form-group">
                        <file-drop-zone id="fileDrop" text="Select image to compress"></file-drop-zone>
                    </div>
                    
                    <!-- Quality -->
                    <div class="range-group">
                        <div class="range-label">
                            <span class="range-title">Quality</span>
                            <span class="range-value" id="qualityValue">80%</span>
                        </div>
                        <input type="range" id="quality" class="range-slider" min="10" max="100" value="80">
                    </div>
                    
                    <!-- Max Dimensions -->
                    <div class="form-group">
                        <label class="form-label" for="maxWidth">Max Width (px)</label>
                        <input type="number" id="maxWidth" class="form-control" placeholder="No limit" min="1">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="maxHeight">Max Height (px)</label>
                        <input type="number" id="maxHeight" class="form-control" placeholder="No limit" min="1">
                    </div>
                    
                    <!-- Format -->
                    <div class="form-group">
                        <label class="form-label" for="outputFormat">Output Format</label>
                        <select id="outputFormat" class="select-control">
                            <option value="jpeg">JPEG</option>
                            <option value="png">PNG</option>
                            <option value="webp">WebP</option>
                        </select>
                    </div>
                    
                    <!-- Actions -->
                    <div class="tool-actions">
                        <button id="compressImage" class="btn btn-primary" disabled>Compress Image</button>
                        <button id="downloadCompressed" class="btn btn-success" disabled>Download</button>
                    </div>
                </div>
                
                <!-- Preview Panel -->
                <div class="tool-panel">
                    <h2 class="tool-panel-title">Preview</h2>
                    <div class="compress-preview">
                        <div class="compress-before">
                            <div class="compress-label">Original</div>
                            <div class="compress-image" id="originalPreview">
                                <div class="image-preview-empty">
                                    <p>Upload an image to compress</p>
                                </div>
                            </div>
                        </div>
                        <div class="compress-after">
                            <div class="compress-label">Compressed</div>
                            <div class="compress-image" id="compressedPreview">
                                <div class="image-preview-empty">
                                    <p>Compressed image will appear here</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Compression Stats -->
                    <div id="compressionStats" class="compress-stats" style="display: none;">
                        <div class="compress-stat">
                            <span class="compress-stat-label">Original Size</span>
                            <span class="compress-stat-value" id="originalSize">-</span>
                        </div>
                        <div class="compress-stat">
                            <span class="compress-stat-label">Compressed Size</span>
                            <span class="compress-stat-value" id="compressedSize">-</span>
                        </div>
                        <div class="compress-stat">
                            <span class="compress-stat-label">Savings</span>
                            <span class="compress-stat-value compress-savings" id="savings">-</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <!-- Footer -->
    <div id="footer-container"></div>
    
    <!-- Scripts -->
    <script type="module" src="/scripts/ui/header.js"></script>
    <script type="module" src="/scripts/ui/footer.js"></script>
    <script type="module" src="/scripts/core/i18n.js"></script>
    <script type="module" src="/scripts/ui/theme.js"></script>
    <script type="module" src="/scripts/ui/toasts.js"></script>
    <script type="module" src="/scripts/ui/file-drop.js"></script>
    <script type="module" src="/scripts/core/image-utils.js"></script>
    <script type="module" src="/scripts/core/download.js"></script>
    <script type="module" src="/scripts/core/worker-pool.js"></script>
    <script type="module" src="/scripts/ui/layout-components.js"></script>
    
    <!-- Compress Tool Script -->
    <script type="module">
        import { I18n } from '/scripts/core/i18n.js'
        import themeManager from '/scripts/ui/theme.js'
        import toastManager from '/scripts/ui/toasts.js'
        import { ImageUtils } from '/scripts/core/image-utils.js'
        import { DownloadUtils } from '/scripts/core/download.js'
        import { WorkerPools } from '/scripts/core/worker-pool.js'
        import LayoutComponents from '/scripts/ui/layout-components.js'
        
        class CompressTool {
            constructor() {
                this.originalImage = null
                this.compressedImage = null
                this.originalFile = null
                this.workerPool = null
                
                this.init()
            }
            
            init() {
                this.setupEventListeners()
                this.updateUI()
                
                // Initialize worker pool
                if (WorkerPools.compress) {
                    this.workerPool = WorkerPools.compress
                }
            }
            
            setupEventListeners() {
                // File drop zone
                const fileDrop = document.getElementById('fileDrop')
                fileDrop.setOnFileSelected(this.handleFileSelect.bind(this))
                
                // Quality slider
                const qualitySlider = document.getElementById('quality')
                qualitySlider.addEventListener('input', (e) => {
                    document.getElementById('qualityValue').textContent = e.target.value + '%'
                })
                
                // Action buttons
                document.getElementById('compressImage').addEventListener('click', () => {
                    this.compressImage()
                })
                
                document.getElementById('downloadCompressed').addEventListener('click', () => {
                    this.downloadCompressed()
                })
            }
            
            handleFileSelect(file) {
                if (!file || !file.type.startsWith('image/')) {
                    toastManager.error('Please select a valid image file')
                    return
                }
                
                this.originalFile = file
                
                const reader = new FileReader()
                reader.onload = (e) => {
                    this.loadImage(e.target.result)
                }
                reader.readAsDataURL(file)
            }
            
            loadImage(imageSrc) {
                const img = new Image()
                img.onload = () => {
                    this.originalImage = img
                    this.displayOriginalImage(img)
                    this.updateUI()
                    toastManager.success('Image loaded successfully')
                }
                img.onerror = () => {
                    toastManager.error('Failed to load image')
                }
                img.src = imageSrc
            }
            
            displayOriginalImage(img) {
                const preview = document.getElementById('originalPreview')
                preview.innerHTML = ''
                
                const displayCanvas = document.createElement('canvas')
                const displayCtx = displayCanvas.getContext('2d')
                
                // Scale for display
                const maxDisplaySize = 300
                const scale = Math.min(maxDisplaySize / img.width, maxDisplaySize / img.height, 1)
                
                displayCanvas.width = img.width * scale
                displayCanvas.height = img.height * scale
                
                displayCtx.drawImage(img, 0, 0, displayCanvas.width, displayCanvas.height)
                
                preview.appendChild(displayCanvas)
                
                // Update file size info
                document.getElementById('originalSize').textContent = DownloadUtils.formatFileSize(this.originalFile.size)
            }
            
            async compressImage() {
                console.log('compressImage called')
                console.log('originalImage:', !!this.originalImage)
                console.log('originalFile:', !!this.originalFile)
                
                if (!this.originalImage || !this.originalFile) {
                    toastManager.error('Please select an image first')
                    return
                }
                
                try {
                    toastManager.info('Compressing image...')
                    
                    const quality = parseInt(document.getElementById('quality').value) / 100
                    const maxWidth = parseInt(document.getElementById('maxWidth').value) || null
                    const maxHeight = parseInt(document.getElementById('maxHeight').value) || null
                    const format = document.getElementById('outputFormat').value
                    
                    console.log('Compression settings:', { quality, maxWidth, maxHeight, format })
                    
                    // Always use client-side compression for now
                    await this.clientSideCompress(quality, maxWidth, maxHeight, format)
                    
                } catch (error) {
                    console.error('Compression failed:', error)
                    toastManager.error('Failed to compress image: ' + error.message)
                }
            }
            
            async clientSideCompress(quality, maxWidth, maxHeight, format) {
                console.log('clientSideCompress started')
                console.log('Format:', format, 'Quality:', quality)
                
                try {
                    const canvas = document.createElement('canvas')
                    const ctx = canvas.getContext('2d')
                    
                    let { width, height } = this.originalImage
                    console.log('Original dimensions:', width, 'x', height)
                    
                    // Resize if needed
                    if (maxWidth && width > maxWidth) {
                        height = (height * maxWidth) / width
                        width = maxWidth
                    }
                    
                    if (maxHeight && height > maxHeight) {
                        width = (width * maxHeight) / height
                        height = maxHeight
                    }
                    
                    console.log('New dimensions:', width, 'x', height)
                    
                    canvas.width = width
                    canvas.height = height
                    
                    // Draw image
                    ctx.drawImage(this.originalImage, 0, 0, width, height)
                    console.log('Image drawn to canvas')
                    
                    // For PNG, apply quality by reducing color depth or using compression level
                    let blob
                    if (format === 'png') {
                        // For PNG, we'll use a different approach since quality parameter doesn't work
                        // We can reduce the color depth or apply other optimizations
                        const imageData = ctx.getImageData(0, 0, width, height)
                        const optimizedData = this.optimizePNGData(imageData, quality)
                        ctx.putImageData(optimizedData, 0, 0)
                        
                        blob = await new Promise((resolve, reject) => {
                            canvas.toBlob((blob) => {
                                if (blob) {
                                    console.log('PNG blob created, size:', blob.size)
                                    resolve(blob)
                                } else {
                                    reject(new Error('Failed to create PNG blob'))
                                }
                            }, 'image/png')
                        })
                    } else {
                        // For JPEG and WebP, quality parameter works directly
                        blob = await new Promise((resolve, reject) => {
                            canvas.toBlob((blob) => {
                                if (blob) {
                                    console.log('Blob created, size:', blob.size)
                                    resolve(blob)
                                } else {
                                    reject(new Error('Failed to create blob'))
                                }
                            }, `image/${format}`, quality)
                        })
                    }
                    
                    // Convert to data URL
                    const compressedData = await new Promise((resolve, reject) => {
                        const reader = new FileReader()
                        reader.onload = () => {
                            console.log('Data URL created, length:', reader.result.length)
                            resolve(reader.result)
                        }
                        reader.onerror = () => reject(new Error('Failed to read blob'))
                        reader.readAsDataURL(blob)
                    })
                    
                    console.log('Calling displayCompressedImage')
                    
                    await this.displayCompressedImageAsync(compressedData, {
                        originalSize: this.originalFile.size,
                        compressedSize: blob.size,
                        width,
                        height,
                        format,
                        quality
                    })
                    
                    toastManager.success('Image compressed successfully')
                    console.log('Compression completed successfully')
                    
                } catch (error) {
                    console.error('Error in clientSideCompress:', error)
                    throw error
                }
            }
            
            optimizePNGData(imageData, quality) {
                console.log('Optimizing PNG data with quality:', quality)
                
                // For PNG, we can apply various optimizations based on quality
                const data = imageData.data
                
                // Simple optimization: reduce color information for lower quality
                if (quality < 0.8) {
                    // Reduce color precision for lower quality settings
                    const factor = Math.floor(quality * 8) + 1  // 1-8 levels
                    console.log('Applying PNG color reduction with factor:', factor)
                    
                    for (let i = 0; i < data.length; i += 4) {
                        // Reduce RGB precision
                        data[i] = Math.floor(data[i] / factor) * factor     // Red
                        data[i + 1] = Math.floor(data[i + 1] / factor) * factor // Green
                        data[i + 2] = Math.floor(data[i + 2] / factor) * factor // Blue
                        // Alpha channel remains unchanged
                    }
                }
                
                if (quality < 0.5) {
                    // For very low quality, apply additional dithering or quantization
                    console.log('Applying additional PNG compression')
                    
                    // Simple color quantization - reduce to fewer colors
                    for (let i = 0; i < data.length; i += 4) {
                        data[i] = Math.round(data[i] / 64) * 64     // Red: 0, 64, 128, 192, 255
                        data[i + 1] = Math.round(data[i + 1] / 64) * 64 // Green: 0, 64, 128, 192, 255
                        data[i + 2] = Math.round(data[i + 2] / 64) * 64 // Blue: 0, 64, 128, 192, 255
                    }
                }
                
                return imageData
            }
            
            displayCompressedImage(compressedData, stats) {
                const preview = document.getElementById('compressedPreview')
                preview.innerHTML = ''
                
                const img = new Image()
                img.onload = () => {
                    const displayCanvas = document.createElement('canvas')
                    const displayCtx = displayCanvas.getContext('2d')
                    
                    // Scale for display
                    const maxDisplaySize = 300
                    const scale = Math.min(maxDisplaySize / img.width, maxDisplaySize / img.height, 1)
                    
                    displayCanvas.width = img.width * scale
                    displayCanvas.height = img.height * scale
                    
                    displayCtx.drawImage(img, 0, 0, displayCanvas.width, displayCanvas.height)
                    
                    preview.appendChild(displayCanvas)
                    
                    // Store compressed image
                    this.compressedImage = img
                    this.compressedData = compressedData
                    this.compressedStats = stats
                    
                    // Update stats
                    this.updateCompressionStats(stats)
                    this.updateUI()
                }
                img.onerror = () => {
                    console.error('Failed to load compressed image')
                }
                img.src = compressedData
            }
            
            async displayCompressedImageAsync(compressedData, stats) {
                console.log('displayCompressedImageAsync started')
                
                return new Promise((resolve, reject) => {
                    const preview = document.getElementById('compressedPreview')
                    if (!preview) {
                        reject(new Error('Preview element not found'))
                        return
                    }
                    
                    preview.innerHTML = ''
                    
                    const img = new Image()
                    img.onload = () => {
                        try {
                            console.log('Compressed image loaded, dimensions:', img.width, 'x', img.height)
                            
                            const displayCanvas = document.createElement('canvas')
                            const displayCtx = displayCanvas.getContext('2d')
                            
                            // Scale for display
                            const maxDisplaySize = 300
                            const scale = Math.min(maxDisplaySize / img.width, maxDisplaySize / img.height, 1)
                            
                            displayCanvas.width = img.width * scale
                            displayCanvas.height = img.height * scale
                            
                            displayCtx.drawImage(img, 0, 0, displayCanvas.width, displayCanvas.height)
                            
                            preview.appendChild(displayCanvas)
                            
                            // Store compressed image
                            this.compressedImage = img
                            this.compressedData = compressedData
                            this.compressedStats = stats
                            
                            // Update stats
                            this.updateCompressionStats(stats)
                            this.updateUI()
                            
                            console.log('Compressed image displayed successfully')
                            resolve()
                            
                        } catch (error) {
                            console.error('Error in image onload:', error)
                            reject(error)
                        }
                    }
                    img.onerror = () => {
                        console.error('Failed to load compressed image')
                        reject(new Error('Failed to load compressed image'))
                    }
                    img.src = compressedData
                })
            }
            
            updateCompressionStats(stats) {
                const savings = ((stats.originalSize - stats.compressedSize) / stats.originalSize * 100).toFixed(1)
                
                document.getElementById('compressedSize').textContent = DownloadUtils.formatFileSize(stats.compressedSize)
                document.getElementById('savings').textContent = `${savings}% (${DownloadUtils.formatFileSize(stats.originalSize - stats.compressedSize)})`
                document.getElementById('compressionStats').style.display = 'flex'
            }
            
            downloadCompressed() {
                if (!this.compressedData) {
                    toastManager.error('No compressed image to download')
                    return
                }
                
                const format = document.getElementById('outputFormat').value
                const filename = `compressed_image_${Date.now()}.${format === 'jpeg' ? 'jpg' : format}`
                
                // Convert data URL to blob
                const blob = DownloadUtils.dataURLToBlob(this.compressedData)
                DownloadUtils.downloadFile(blob, filename)
                
                toastManager.success('Image downloaded successfully')
            }
            
            updateUI() {
                const hasImage = this.originalImage !== null
                const hasCompressed = this.compressedImage !== null
                
                const compressBtn = document.getElementById('compressImage')
                const downloadBtn = document.getElementById('downloadCompressed')
                
                if (compressBtn) {
                    compressBtn.disabled = !hasImage
                }
                
                if (downloadBtn) {
                    downloadBtn.disabled = !hasCompressed
                }
                
                console.log('UI updated - hasImage:', hasImage, 'hasCompressed:', hasCompressed)
                console.log('Download button disabled:', !hasCompressed)
            }
        }
        
        // Initialize compress tool when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize layout components
            const layout = new LayoutComponents()
            layout.init()
            
            // Initialize i18n
            I18n.init()
            
            // Initialize theme
            themeManager.init()
            
            // Initialize compress tool
            const compressTool = new CompressTool()
        })
    </script>
</body>
</html>