<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="crop.pageTitle">Crop Image Online - Free Image Cropping Tool</title>
    <meta name="description" content="Free online image cropping tool. Crop images to exact dimensions with aspect ratio presets. No registration required." data-i18n-content="crop.metaDescription">
    <meta name="keywords" content="crop image, image cropper, online crop tool, free crop image, resize crop" data-i18n-content="crop.keywords">
    <meta name="author" content="Free Image Tools Online">
    <link rel="canonical" href="https://freeimagetools.online/tools/crop/">
    
    <!-- Open Graph -->
    <meta property="og:title" content="Crop Image Online - Free Image Cropping Tool">
    <meta property="og:description" content="Free online image cropping tool. Crop images to exact dimensions with aspect ratio presets.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://freeimagetools.online/tools/crop/">
    <meta property="og:image" content="https://freeimagetools.online/assets/og-crop.png">
    
    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Crop Image Online - Free Image Cropping Tool">
    <meta name="twitter:description" content="Free online image cropping tool. Crop images to exact dimensions with aspect ratio presets.">
    <meta name="twitter:image" content="https://freeimagetools.online/assets/og-crop.png">
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="/assets/favicon.svg">
    <link rel="apple-touch-icon" href="/assets/apple-touch-icon.png">
    
    <!-- CSS -->
    <link rel="stylesheet" href="/styles/base.css">
    <link rel="stylesheet" href="/styles/theme.css">
    <link rel="stylesheet" href="/styles/header.css">
    <link rel="stylesheet" href="/styles/footer.css">
    <link rel="stylesheet" href="/styles/components.css">
    <link rel="stylesheet" href="/styles/tools.css">
    
    <!-- JSON-LD Structured Data -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "SoftwareApplication",
        "name": "Image Crop Tool",
        "description": "Free online image cropping tool with aspect ratio presets",
        "url": "https://freeimagetools.online/tools/crop/",
        "applicationCategory": "ImageEditorApplication",
        "operatingSystem": "Web Browser",
        "author": {
            "@type": "Organization",
            "name": "Free Image Tools Online"
        },
        "offers": {
            "@type": "Offer",
            "price": "0",
            "priceCurrency": "USD"
        }
    }
    </script>
</head>
<body>
    <!-- Skip to content -->
    <a href="#main-content" class="skip-to-content">Skip to content</a>
    
    <!-- Header -->
    <div id="header-container"></div>
    
    <!-- Main Content -->
    <main id="main-content">
        <div class="tool-container">
            <div class="tool-header">
                <h1 class="tool-title" data-i18n="crop.title">Crop Image</h1>
                <p class="tool-description" data-i18n="crop.description">Crop your image to desired dimensions with precise control</p>
            </div>
            
            <div class="tool-layout">
                <!-- Controls Panel -->
                <div class="tool-panel">
                    <h2 class="tool-panel-title" data-i18n="crop.settingsTitle">Crop Settings</h2>
                    
                    <!-- File Upload -->
                    <div class="form-group">
                        <file-drop-zone id="fileDrop" text="Select image to crop" data-i18n-text="common.dragDrop"></file-drop-zone>
                    </div>
                    
                    <!-- Aspect Ratio -->
                    <div class="form-group">
                        <label class="form-label" data-i18n="crop.aspectRatio">Aspect Ratio</label>
                        <div class="aspect-ratio-buttons">
                            <button class="aspect-ratio-btn active" data-ratio="free" data-i18n="crop.freeform">Free</button>
                            <button class="aspect-ratio-btn" data-ratio="1:1">1:1</button>
                            <button class="aspect-ratio-btn" data-ratio="4:3">4:3</button>
                            <button class="aspect-ratio-btn" data-ratio="16:9">16:9</button>
                            <button class="aspect-ratio-btn" data-ratio="9:16">9:16</button>
                            <button class="aspect-ratio-btn" data-ratio="3:2">3:2</button>
                            <button class="aspect-ratio-btn" data-ratio="2:3">2:3</button>
                        </div>
                    </div>
                    
                    <!-- Dimensions -->
                    <div class="crop-controls">
                        <div class="form-group">
                            <label class="form-label" for="cropWidth" data-i18n="crop.width">Width (px)</label>
                            <input type="number" id="cropWidth" class="form-control" placeholder="Auto" min="1" data-i18n-placeholder="crop.auto">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="cropHeight" data-i18n="crop.height">Height (px)</label>
                            <input type="number" id="cropHeight" class="form-control" placeholder="Auto" min="1" data-i18n-placeholder="crop.auto">
                        </div>
                    </div>
                    
                    <!-- Maintain Aspect Ratio -->
                    <div class="form-group">
                        <label class="checkbox-item">
                            <input type="checkbox" id="maintainRatio" class="checkbox-input" checked>
                            <span class="checkbox-label" data-i18n="crop.maintainRatio">Maintain Aspect Ratio</span>
                        </label>
                    </div>
                    
                    <!-- Actions -->
                    <div class="tool-actions">
                        <button id="resetCrop" class="btn btn-secondary" disabled data-i18n="common.reset">Reset</button>
                        <button id="applyCrop" class="btn btn-primary" disabled data-i18n="crop.applyCrop">Apply Crop</button>
                        <button id="downloadCrop" class="btn btn-success" disabled data-i18n="common.download">Download</button>
                    </div>
                </div>
                
                <!-- Preview Panel -->
                <div class="tool-panel">
                    <h2 class="tool-panel-title" data-i18n="common.preview">Preview</h2>
                    <div class="image-preview" id="cropPreview">
                        <div class="image-preview-empty">
                            <p data-i18n="crop.uploadPrompt">Upload an image to start cropping</p>
                        </div>
                    </div>
                    
                    <!-- Image Info -->
                    <div id="imageInfo" class="image-preview-info" style="display: none;">
                        <div class="compress-stats">
                            <div class="compress-stat">
                                <span class="compress-stat-label" data-i18n="crop.originalSize">Original Size</span>
                                <span class="compress-stat-value" id="originalSize">-</span>
                            </div>
                            <div class="compress-stat">
                                <span class="compress-stat-label" data-i18n="crop.croppedSize">Cropped Size</span>
                                <span class="compress-stat-value" id="croppedSize">-</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <!-- Footer -->
    <div id="footer-container"></div>
    
    <!-- Scripts -->
    <script type="module" src="/scripts/ui/header.js"></script>
    <script type="module" src="/scripts/ui/footer.js"></script>
    <script type="module" src="/scripts/core/i18n.js"></script>
    <script type="module" src="/scripts/ui/theme.js"></script>
    <script type="module" src="/scripts/ui/toasts.js"></script>
    <script type="module" src="/scripts/ui/file-drop.js"></script>
    <script type="module" src="/scripts/core/image-utils.js"></script>
    <script type="module" src="/scripts/core/download.js"></script>
    <script type="module" src="/scripts/ui/layout-components.js"></script>
    
    <!-- Enhanced Crop Tool Script -->
    <script type="module">
        import { I18n } from '/scripts/core/i18n.js'
        import themeManager from '/scripts/ui/theme.js'
        import toastManager from '/scripts/ui/toasts.js'
        import { ImageUtils } from '/scripts/core/image-utils.js'
        import { DownloadUtils } from '/scripts/core/download.js'
        import LayoutComponents from '/scripts/ui/layout-components.js'
        
        class EnhancedCropTool {
            constructor() {
                this.originalImage = null
                this.originalFile = null
                this.croppedImage = null
                this.currentAspectRatio = 'free'
                this.maintainRatio = true
                this.cropData = {
                    x: 0, y: 0, width: 0, height: 0,
                    isDragging: false, isResizing: false, resizeHandle: null,
                    startX: 0, startY: 0
                }
                this.canvas = null
                this.ctx = null
                this.overlay = null
                
                this.init()
            }
            
            init() {
                this.setupEventListeners()
                this.updateUI()
            }
            
            setupEventListeners() {
                // File drop zone
                const fileDrop = document.getElementById('fileDrop')
                fileDrop.setOnFileSelected(this.handleFileSelect.bind(this))
                
                // Aspect ratio buttons
                document.querySelectorAll('.aspect-ratio-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        this.setAspectRatio(btn.dataset.ratio)
                    })
                })
                
                // Dimension inputs
                const widthInput = document.getElementById('cropWidth')
                const heightInput = document.getElementById('cropHeight')
                
                widthInput.addEventListener('input', () => {
                    this.updateCropFromInputs()
                })
                
                heightInput.addEventListener('input', () => {
                    this.updateCropFromInputs()
                })
                
                // Maintain ratio checkbox
                document.getElementById('maintainRatio').addEventListener('change', (e) => {
                    this.maintainRatio = e.target.checked
                })
                
                // Action buttons
                document.getElementById('resetCrop').addEventListener('click', () => {
                    this.resetCrop()
                })
                
                document.getElementById('applyCrop').addEventListener('click', () => {
                    this.applyCrop()
                })
                
                document.getElementById('downloadCrop').addEventListener('click', () => {
                    this.downloadCroppedImage()
                })
            }
            
            handleFileSelect(file) {
                if (!file || !file.type.startsWith('image/')) {
                    toastManager.error('Please select a valid image file')
                    return
                }
                
                const reader = new FileReader()
                reader.onload = (e) => {
                    this.loadImage(e.target.result, file)
                }
                reader.readAsDataURL(file)
            }
            
            loadImage(imageSrc, file) {
                const img = new Image()
                img.onload = () => {
                    this.originalImage = img
                    this.originalFile = file
                    this.displayImage(img)
                    this.updateUI()
                    toastManager.success('Image loaded successfully')
                }
                img.onerror = () => {
                    toastManager.error('Failed to load image')
                }
                img.src = imageSrc
            }
            
            displayImage(img) {
                const preview = document.getElementById('cropPreview')
                preview.innerHTML = `
                    <div class="canvas-container" style="position: relative; display: inline-block;">
                        <canvas id="cropCanvas" style="max-width: 100%; height: auto; border: 1px solid #ddd;"></canvas>
                        <div class="crop-overlay" id="cropOverlay"></div>
                    </div>
                `
                
                this.canvas = document.getElementById('cropCanvas')
                this.ctx = this.canvas.getContext('2d')
                this.overlay = document.getElementById('cropOverlay')
                
                // Set canvas size
                const maxWidth = preview.clientWidth - 40
                const maxHeight = 400
                
                let { width, height } = img
                
                if (width > maxWidth) {
                    height = (height * maxWidth) / width
                    width = maxWidth
                }
                
                if (height > maxHeight) {
                    width = (width * maxHeight) / height
                    height = maxHeight
                }
                
                this.canvas.width = width
                this.canvas.height = height
                
                // Draw image
                this.ctx.drawImage(img, 0, 0, width, height)
                
                // Update image info
                this.updateImageInfo(img.width, img.height)
                
                // Initialize crop area
                this.initializeCropArea()
                
                // Setup canvas events
                this.setupCanvasEvents()
            }
            
            initializeCropArea() {
                // Start with full canvas size (no gaps)
                this.cropData = {
                    x: 0,
                    y: 0,
                    width: this.canvas.width,
                    height: this.canvas.height,
                    isDragging: false,
                    isResizing: false,
                    resizeHandle: null,
                    startX: 0,
                    startY: 0
                }
                
                // Apply current aspect ratio if set
                if (this.currentAspectRatio !== 'free' && this.maintainRatio) {
                    this.setAspectRatio(this.currentAspectRatio)
                } else {
                    this.updateCropArea()
                }
            }
            
            setupCanvasEvents() {
                this.canvas.addEventListener('mousedown', (e) => this.handleMouseDown(e))
                this.canvas.addEventListener('mousemove', (e) => this.handleMouseMove(e))
                this.canvas.addEventListener('mouseup', () => this.handleMouseUp())
                this.canvas.addEventListener('mouseleave', () => this.handleMouseUp())
            }
            
            handleMouseDown(e) {
                const rect = this.canvas.getBoundingClientRect()
                const x = e.clientX - rect.left
                const y = e.clientY - rect.top
                
                // Check if clicking on resize handle
                const handle = this.getResizeHandle(x, y)
                if (handle) {
                    this.cropData.isResizing = true
                    this.cropData.resizeHandle = handle
                    this.cropData.startX = x
                    this.cropData.startY = y
                    return
                }
                
                // Check if clicking inside crop area
                if (this.isInsideCropArea(x, y)) {
                    this.cropData.isDragging = true
                    this.cropData.startX = x - this.cropData.x
                    this.cropData.startY = y - this.cropData.y
                    return
                }
                
                // Start new selection
                this.cropData.x = x
                this.cropData.y = y
                this.cropData.width = 0
                this.cropData.height = 0
                this.cropData.isResizing = true
                this.cropData.resizeHandle = 'bottom-right'
            }
            
            handleMouseMove(e) {
                const rect = this.canvas.getBoundingClientRect()
                const x = e.clientX - rect.left
                const y = e.clientY - rect.top
                
                if (this.cropData.isResizing) {
                    this.handleResize(x, y)
                } else if (this.cropData.isDragging) {
                    this.handleDrag(x, y)
                } else {
                    this.updateCursor(x, y)
                }
            }
            
            handleMouseUp() {
                this.cropData.isDragging = false
                this.cropData.isResizing = false
                this.cropData.resizeHandle = null
            }
            
            handleResize(x, y) {
                const handle = this.cropData.resizeHandle
                const startX = this.cropData.startX
                const startY = this.cropData.startY
                
                switch (handle) {
                    case 'top-left':
                        this.cropData.width = this.cropData.x + this.cropData.width - x
                        this.cropData.height = this.cropData.y + this.cropData.height - y
                        this.cropData.x = x
                        this.cropData.y = y
                        break
                    case 'top-right':
                        this.cropData.width = x - this.cropData.x
                        this.cropData.height = this.cropData.y + this.cropData.height - y
                        this.cropData.y = y
                        break
                    case 'bottom-left':
                        this.cropData.width = this.cropData.x + this.cropData.width - x
                        this.cropData.height = y - this.cropData.y
                        this.cropData.x = x
                        break
                    case 'bottom-right':
                        this.cropData.width = x - this.cropData.x
                        this.cropData.height = y - this.cropData.y
                        break
                }
                
                this.updateCropArea()
            }
            
            handleDrag(x, y) {
                this.cropData.x = x - this.cropData.startX
                this.cropData.y = y - this.cropData.startY
                this.updateCropArea()
            }
            
            getResizeHandle(x, y) {
                const handles = ['top-left', 'top-right', 'bottom-left', 'bottom-right']
                const threshold = 10
                
                for (let handle of handles) {
                    if (this.isNearHandle(x, y, handle, threshold)) {
                        return handle
                    }
                }
                return null
            }
            
            isNearHandle(x, y, handle, threshold) {
                const handlePos = this.getHandlePosition(handle)
                return Math.abs(x - handlePos.x) <= threshold && Math.abs(y - handlePos.y) <= threshold
            }
            
            getHandlePosition(handle) {
                switch (handle) {
                    case 'top-left':
                        return { x: this.cropData.x, y: this.cropData.y }
                    case 'top-right':
                        return { x: this.cropData.x + this.cropData.width, y: this.cropData.y }
                    case 'bottom-left':
                        return { x: this.cropData.x, y: this.cropData.y + this.cropData.height }
                    case 'bottom-right':
                        return { x: this.cropData.x + this.cropData.width, y: this.cropData.y + this.cropData.height }
                    default:
                        return { x: 0, y: 0 }
                }
            }
            
            isInsideCropArea(x, y) {
                return x >= this.cropData.x && x <= this.cropData.x + this.cropData.width &&
                       y >= this.cropData.y && y <= this.cropData.y + this.cropData.height
            }
            
            updateCursor(x, y) {
                const handle = this.getResizeHandle(x, y)
                
                if (handle) {
                    if (handle.includes('left') && handle.includes('top') || handle.includes('right') && handle.includes('bottom')) {
                        this.canvas.style.cursor = 'nw-resize'
                    } else {
                        this.canvas.style.cursor = 'ne-resize'
                    }
                } else if (this.isInsideCropArea(x, y)) {
                    this.canvas.style.cursor = 'move'
                } else {
                    this.canvas.style.cursor = 'crosshair'
                }
            }
            
            updateCropArea() {
                // Apply aspect ratio
                if (this.currentAspectRatio !== 'free' && this.maintainRatio) {
                    const ratio = this.getAspectRatioValue()
                    if (ratio) {
                        // Calculate maximum possible size for this aspect ratio
                        const maxWidth = this.canvas.width - this.cropData.x
                        const maxHeight = this.canvas.height - this.cropData.y
                        
                        let newWidth, newHeight
                        
                        if (maxWidth / maxHeight > ratio) {
                            // Height is the limiting factor
                            newHeight = maxHeight
                            newWidth = newHeight * ratio
                        } else {
                            // Width is the limiting factor
                            newWidth = maxWidth
                            newHeight = newWidth / ratio
                        }
                        
                        // But don't make it smaller than current size
                        this.cropData.width = Math.max(this.cropData.width, newWidth)
                        this.cropData.height = Math.max(this.cropData.height, newHeight)
                        
                        // Also don't make it larger than available space
                        this.cropData.width = Math.min(this.cropData.width, maxWidth)
                        this.cropData.height = Math.min(this.cropData.height, maxHeight)
                    }
                }
                
                // Constrain to canvas bounds
                this.cropData.x = Math.max(0, Math.min(this.cropData.x, this.canvas.width - this.cropData.width))
                this.cropData.y = Math.max(0, Math.min(this.cropData.y, this.canvas.height - this.cropData.height))
                this.cropData.width = Math.max(10, Math.min(this.cropData.width, this.canvas.width - this.cropData.x))
                this.cropData.height = Math.max(10, Math.min(this.cropData.height, this.canvas.height - this.cropData.y))
                
                // Update overlay
                this.updateOverlay()
                
                // Update inputs
                this.updateInputs()
                
                // Update info
                this.updateCropInfo()
            }
            
            updateOverlay() {
                this.overlay.style.position = 'absolute'
                this.overlay.style.left = this.cropData.x + 'px'
                this.overlay.style.top = this.cropData.y + 'px'
                this.overlay.style.width = this.cropData.width + 'px'
                this.overlay.style.height = this.cropData.height + 'px'
                this.overlay.style.border = '2px solid #3b82f6'
                this.overlay.style.backgroundColor = 'rgba(59, 130, 246, 0.1)'
                this.overlay.style.pointerEvents = 'none'
            }
            
            updateInputs() {
                const scaleX = this.originalImage.width / this.canvas.width
                const scaleY = this.originalImage.height / this.canvas.height
                
                document.getElementById('cropWidth').value = Math.round(this.cropData.width * scaleX)
                document.getElementById('cropHeight').value = Math.round(this.cropData.height * scaleY)
            }
            
            updateImageInfo(originalWidth, originalHeight) {
                document.getElementById('originalSize').textContent = `${originalWidth} × ${originalHeight}`
                document.getElementById('imageInfo').style.display = 'block'
            }
            
            updateCropInfo() {
                const scaleX = this.originalImage.width / this.canvas.width
                const scaleY = this.originalImage.height / this.canvas.height
                
                const actualWidth = Math.round(this.cropData.width * scaleX)
                const actualHeight = Math.round(this.cropData.height * scaleY)
                
                document.getElementById('croppedSize').textContent = `${actualWidth} × ${actualHeight}`
            }
            
            updateCropFromInputs() {
                const width = parseInt(document.getElementById('cropWidth').value)
                const height = parseInt(document.getElementById('cropHeight').value)
                
                if (width && height && this.originalImage) {
                    const scaleX = this.canvas.width / this.originalImage.width
                    const scaleY = this.canvas.height / this.originalImage.height
                    
                    this.cropData.width = width * scaleX
                    this.cropData.height = height * scaleY
                    
                    this.updateCropArea()
                }
            }
            
            getAspectRatioValue() {
                const ratios = {
                    '1:1': 1,
                    '4:3': 4/3,
                    '16:9': 16/9,
                    '9:16': 9/16,
                    '3:2': 3/2,
                    '2:3': 2/3
                }
                return ratios[this.currentAspectRatio]
            }
            
            setAspectRatio(ratio) {
                this.currentAspectRatio = ratio
                
                // Update button states
                document.querySelectorAll('.aspect-ratio-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.ratio === ratio)
                })
                
                // Recalculate maximum crop area for this aspect ratio
                if (this.originalImage && this.maintainRatio) {
                    const ratioValue = this.getAspectRatioValue()
                    if (ratioValue && ratio !== 'free') {
                        // Use the entire canvas to maximize crop area
                        const canvasWidth = this.canvas.width
                        const canvasHeight = this.canvas.height
                        
                        // Calculate the maximum size that fits the canvas
                        let newWidth, newHeight
                        
                        if (canvasWidth / canvasHeight > ratioValue) {
                            // Canvas is wider than ratio, height is limiting factor
                            newHeight = canvasHeight
                            newWidth = newHeight * ratioValue
                        } else {
                            // Canvas is taller than ratio, width is limiting factor
                            newWidth = canvasWidth
                            newHeight = newWidth / ratioValue
                        }
                        
                        // Position to fill entire canvas (no gaps)
                        this.cropData.x = 0
                        this.cropData.y = 0
                        this.cropData.width = newWidth
                        this.cropData.height = newHeight
                        
                        this.updateOverlay()
                        this.updateInputs()
                        this.updateCropInfo()
                    }
                }
            }
            
            resetCrop() {
                if (!this.originalImage) return
                this.initializeCropArea()
                toastManager.success('Crop reset to full image')
            }
            
            applyCrop() {
                if (!this.originalImage || !this.cropData) {
                    toastManager.error('Please select an image first')
                    return
                }
                
                const scaleX = this.originalImage.width / this.canvas.width
                const scaleY = this.originalImage.height / this.canvas.height
                
                const cropCanvas = document.createElement('canvas')
                const ctx = cropCanvas.getContext('2d')
                
                cropCanvas.width = Math.round(this.cropData.width * scaleX)
                cropCanvas.height = Math.round(this.cropData.height * scaleY)
                
                ctx.drawImage(
                    this.originalImage,
                    Math.round(this.cropData.x * scaleX),
                    Math.round(this.cropData.y * scaleY),
                    Math.round(this.cropData.width * scaleX),
                    Math.round(this.cropData.height * scaleY),
                    0, 0,
                    cropCanvas.width,
                    cropCanvas.height
                )
                
                this.croppedImage = cropCanvas
                
                // Update preview
                const preview = document.getElementById('cropPreview')
                preview.innerHTML = `
                    <div class="canvas-container">
                        <img id="cropResult" src="${cropCanvas.toDataURL()}" style="max-width: 100%; height: auto; border: 1px solid #ddd;">
                    </div>
                `
                
                // Update UI
                document.getElementById('applyCrop').disabled = true
                document.getElementById('downloadCrop').disabled = false
                
                // Update cropped size
                document.getElementById('croppedSize').textContent = `${cropCanvas.width} × ${cropCanvas.height}`
                
                toastManager.success('Crop applied successfully')
            }
            
            downloadCroppedImage() {
                if (!this.croppedImage) {
                    toastManager.error('No cropped image to download')
                    return
                }
                
                const filename = `cropped_image_${Date.now()}.png`
                DownloadUtils.downloadCanvas(this.croppedImage, filename)
                toastManager.success('Image downloaded successfully')
            }
            
            updateUI() {
                const hasImage = this.originalImage !== null
                const hasCrop = this.croppedImage !== null
                
                document.getElementById('resetCrop').disabled = !hasImage
                document.getElementById('applyCrop').disabled = !hasImage || hasCrop
                document.getElementById('downloadCrop').disabled = !hasCrop
            }
        }
        
        // Initialize crop tool when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize layout components
            const layout = new LayoutComponents()
            layout.init()
            
            // Initialize i18n
            I18n.init()
            
            // Initialize theme
            themeManager.init()
            
            // Initialize crop tool
            const cropTool = new EnhancedCropTool()
        })
    </script>
</body>
</html>
